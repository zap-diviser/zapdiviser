services:
  frontend:
    build:
      context: ./frontend
    expose:
      - 3000:3000
    networks:
      - local
      - caddy
    depends_on:
      - backend
    environment:
      VITE_BACKEND_URL: backend.${HOST}
    labels:
      caddy: ${HOST}, www.${HOST}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    deploy:
      labels:
        caddy: ${HOST}, www.${HOST}
        caddy.reverse_proxy: "{{upstreams 3000}}"

  backend:
    build:
      context: ./backend
    expose:
      - 8000:8000
    networks:
      - local
      - caddy
    depends_on:
      - db
      - redis
      - minio
    environment:
      HOST: ${HOST}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${zapdiviser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_URL: ${REDIS_URL}
      MINIO_USER: ${MINIO_USER}
      MINIO_PASSWORD: ${MINIO_PASSWORD}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      caddy_0: backend.${HOST}
      caddy_0.reverse_proxy: "{{upstreams 8000}}"
      caddy_1: webhook.${HOST}
      caddy_1.rewrite: "* /api/product/webhook{uri}"
      caddy_1.reverse_proxy: "{{upstreams 8000}}"
      caddy_2: redirect.${HOST}
      caddy_2.rewrite: "* /api/product/redirect{uri}"
      caddy_2.reverse_proxy: "{{upstreams 8000}}"
      caddy_3: admin.${HOST}
      caddy_3.rewrite: "* /admin-br{uri}"
      caddy_3.reverse_proxy: "{{upstreams 8000}}"
    deploy:
      labels:
        caddy_0: backend.${HOST}
        caddy_0.reverse_proxy: "{{upstreams 8000}}"
        caddy_1: webhook.${HOST}
        caddy_1.rewrite: "* /api/product/webhook{uri}"
        caddy_1.reverse_proxy: "{{upstreams 8000}}"
        caddy_2: redirect.${HOST}
        caddy_2.rewrite: "* /api/product/redirect{uri}"
        caddy_2.reverse_proxy: "{{upstreams 8000}}"
        caddy_3: admin.${HOST}
        caddy_3.rewrite: "* /admin-br{uri}"
        caddy_3.reverse_proxy: "{{upstreams 8000}}"
